#!/bin/bash

##
# Primarily used to run the nightly tests on VM.  But, I like source
# control, so I checked it in.  Now there is at least "some" documentation
# and a backup...
# <p>
# HERE IS mevans' crontab entry on VM:
# </p><pre>
# [mevans@VM mevans]$ crontab -l
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# SHELL=/bin/bash
# CVSROOT=:ext:mevans@172.16.31.5:/home/cvs
# CVS_RSH=ssh
# # For some reason, TZ must be explicitly set for date to work.
# TZ=:/etc/localtime
# # Suppress cron email (no effect on cron_run_test's mail_error function)
# MAILTO=""
# 0 5 * * * $HOME/bin/cron_run_tests 2>&1
# [mevans@VM mevans]$ 
# </pre>
# <p>
# INSTALLATION (AT LEAST FOR mevans ON VM):
# </p><pre>
# [mevans@VM mevans]$ pushd .
# [mevans@VM mevans]$ cd /tmp
# [mevans@VM tmp]$ cvs co broadway/tools/cron_run_tests
# [mevans@VM tmp]$ cp broadway/tools/cron_run_tests ~/bin/
# [mevans@VM tmp]$ rm -rf broadway
# [mevans@VM tmp]$ popd
# ~
# [mevans@VM mevans]$
# </pre>
# @fixme Combine CVS checkout for all automated development processes.

mail_stdin () {
# NOTE: This is a HACK to ensure a recent version of Python is used.
/opt/moe25/usr/bin/python-mpx -c '
import smtplib
import sys
from optparse import OptionParser

parser = OptionParser()
parser.add_option("-f", "--from",
                  action="store", type="string", dest="fromaddr",
                  default="dev@richards-zeta.com")
parser.add_option("-t", "--to",
                  action="append", type="string", dest="toaddrs")
parser.add_option("-s", "--subject",
                  action="store", type="string", dest="subject",
                  default="")
parser.add_option("-S", "--server",
                  action="store", type="string", dest="server",
                  default="localhost")
parser.add_option("-p", "--port",
                  action="store", type="int", dest="port",
                  default="25")
parser.add_option("-d", "--debug", action="count", dest="debug_level",
                  default=0)

(options, args) = parser.parse_args()

if not options.toaddrs:
    options.toaddrs = ["dev@richards-zeta.com"]

fromaddr = options.fromaddr
toaddrs  = tuple(options.toaddrs)
msg = ("From: %s\r\nTo: %s\r\nSubject: %s\r\n\r\n"
       % (fromaddr, ", ".join(toaddrs),options.subject))
msg += sys.stdin.read()

server = smtplib.SMTP(options.server, options.port)
server.set_debuglevel(options.debug_level)
server.sendmail(fromaddr, toaddrs, msg)
server.quit()' "$@"
}

mail_error () {
    local err=$1
    local file=$2
    if [ $err != 0 ]
    then
	cat $file | mail_stdin -t "$MAILTO" \
                               -s "Failed to run nightly tests" \
	                       -p "$MAILPORT"
    fi
}

set -xv # "Debug" should be enabled for cron jobs!
PATH=$PATH:~/bin
MAILTO=dev@richards-zeta.com
MAILPORT=2525
TMPDIR=/tmp/$$.cron_run_tests
mkdir ${TMPDIR} || exit 1
BAILSCRIPT="(cd /tmp ; rm -rf ${TMPDIR} ; exit 1) || exit 1"
cd ${TMPDIR} || eval ${BAILSCRIPT}
cvs co broadway/tools/test_from_cvs || eval ${BAILSCRIPT}
cd broadway/tools || eval ${BAILSCRIPT}
chmod a+x ./test_from_cvs
./test_from_cvs --mail-to ${MAILTO} \
                --mail-port ${MAILPORT} \
                --with-buildrc moe25 >test_from_cvs.out 2>&1
mail_error $? test_from_cvs.out
cd /tmp
rm -rf ${TMPDIR}
exit 0
