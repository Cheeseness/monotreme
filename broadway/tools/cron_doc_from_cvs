#!/bin/bash

##
# Publishes the latest source in ~/public_html/nightly_build/src and builds
# the standard documentation ~/public_html/nightly_build/bld and the Monty
# Docs in ~/public_html/nightly_build/bld/montydoc.
#
# Primarily used to publish the latest source and documentation at:
#     https://www.envenergy.com/~mevans/nightly_build
# via a cron job on fearfactory.  But, I like source control, so I checked it
# in.  Now there is at least "some" documentation and a backup...
# <p>
# HERE IS mevans' crontab entry on FEARFACTORY:
# </p><pre>
# [mevans@fearfactory mevans]$ crontab -l
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# SHELL=/bin/bash
# MAILTO=mevans@envenergy.com
# CVSROOT=:ext:mevans@cvs.envenergy.com:/home/cvs
# CVS_RSH=ssh
# 0 4 * * * $HOME/bin/cron_doc_from_cvs 2>&1
# [mevans@fearfactory mevans]$ 
# </pre>
# <p>
# INSTALLATION (AT LEAST FOR mevans ON FEARFACTORY):
# </p><pre>
# [mevans@fearfactory mevans]$ pushd .
# [mevans@fearfactory mevans]$ cd /tmp
# [mevans@fearfactory tmp]$ cvs co broadway/tools/cron_doc_from_cvs
# [mevans@fearfactory tmp]$ cp broadway/tools/cron_doc_from_cvs ~/bin/
# [mevans@fearfactory tmp]$ rm -rf broadway
# [mevans@fearfactory tmp]$ popd
# ~
# [mevans@fearfactory mevans]$
# </pre>

PATH=$PATH:~/bin
PUBLIC_HTML_DIR=~/public_html
NIGHTLY_BUILD_DIR=${PUBLIC_HTML_DIR}/nightly_build
SRC_DIR=${NIGHTLY_BUILD_DIR}/src
BLD_DIR=${NIGHTLY_BUILD_DIR}/bld

echo -n "Deleting previous build and source directories ... "
rm -rf ${BLD_DIR} || exit 1
rm -rf ${SRC_DIR} || exit 1
echo "done."
mkdir -p ${NIGHTLY_BUILD_DIR} || exit 1
echo "cd ${NIGHTLY_BUILD_DIR}"
cd ${NIGHTLY_BUILD_DIR} || exit 1
echo -n "Checking out the 'broadway' module as 'src' ... "
cvs co -d src broadway >CHECKOUT_BROADWAY_LOG.txt 2>&1 || exit 1
echo "done."
echo "cd ${SRC_DIR}/buildsup"
cd ${SRC_DIR}/buildsup || eval ${BAILSCRIPT}
echo -n "Checking out the 'monty_doc' module as 'src/buildsup/monty_doc' ... "
cvs co monty_doc >CHECKOUT_MONTY_DOC_LOG.txt 2>&1 || eval ${BAILSCRIPT}
echo "done."
echo "cd ${SRC_DIR}"
cd ${SRC_DIR} || exit 1
echo -n "Running './setup_configure_script.sh' ... "
./setup_configure_script.sh >SETUP_CONFIGURE_SCRIPT_LOG.txt 2>&1 || exit 1
echo "done."
mkdir -p ${BLD_DIR} || exit 1
echo "cd ${BLD_DIR}"
cd ${BLD_DIR} || exit 1
echo -n "Running '${SRC_DIR}/configure --with-buildrc=native' ... "
${SRC_DIR}/configure --with-buildrc=native >CONFIGURE_LOG.txt 2>&1 || exit 1
echo "done."
echo -n "Running 'make montydoc' ... "
make montydoc >MAKE_MONTYDOC_LOG.txt 2>&1 || exit 1
echo "done."
echo -n "Running 'make doc' ... "
make doc >MAKE_DOC_LOG.txt 2>&1 || exit 1
echo "done."
exit 0
